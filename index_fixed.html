<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sky-Work Bonus — Regioner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Pinned Recharts version (fixes 'Recharts is not defined') -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
  <style>
    body { background:
      radial-gradient(1200px 600px at 10% -10%, rgba(99,102,241,.10), transparent),
      radial-gradient(1200px 600px at 90% -10%, rgba(16,185,129,.10), transparent);
    }
    .glass { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      background: rgba(255,255,255,.60); border: 1px solid rgba(255,255,255,.40);
      border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    input, select { border:1px solid rgba(0,0,0,.15); border-radius:10px; padding:8px 10px; }
    button.btn { border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:8px 12px; }
    #errors { white-space: pre-wrap; color:#991b1b; background:#fff1f2; padding:12px; border-radius:12px; margin-top:12px; display:none }
  </style>
  <script>
    // Show runtime errors on page (so blank screen = never again)
    window.addEventListener('error', function(e){
      var box = document.getElementById('errors'); if(!box) return;
      box.style.display='block'; box.textContent += (e.message || (e.error && e.error.message) || e.toString()) + "\\n";
    });
  </script>
</head>
<body class="min-h-screen">
  <div class="p-6 md:p-10 max-w-7xl mx-auto">
    <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">Sky-Work Bonus — Regioner</h1>
    <p class="opacity-70">Sjælland og Jylland • Fællesudgifter 50/50 • Sygedage → 5% grænse</p>
    <div id="errors"></div>
    <div id="root" class="mt-6"></div>
  </div>

  <script type="text/babel">
    const {
      ResponsiveContainer, BarChart, Bar, CartesianGrid, XAxis, YAxis, Tooltip, Legend
    } = window.Recharts; // <- IMPORTANT: access from window

    const {useState, useMemo, useEffect} = React;

    const DEFAULT = {
      settings: {
        totalProfit: 1000000,
        sharedCosts: 200000,
        totalProfitShare: 0.40,
        shares: { base: 0.30, level: 0.50, seniority: 0.20 },
        sickLimitPct: 0.05,
        hoursPerDay: 7.4,
        minYears: 1,
        minHours: 1000,
        levelFactors: {1:1.0,2:1.5,3:2.0},
        seniorityFactors: {"1-2":1.0,"3-4":1.3,"5+":1.6},
      },
      employees: [
        {id:1,name:"Mads Jensen",region:"JY",level:1,hireDate:"2022-05-23",hours:1000,sickDays:2, breach:false},
        {id:2,name:"Jonas Larsen",region:"SJ",level:2,hireDate:"2022-08-17",hours:1000,sickDays:3, breach:false},
        {id:3,name:"Peter Hansen",region:"JY",level:3,hireDate:"2019-01-02",hours:1000,sickDays:0, breach:false},
        {id:4,name:"Sofie Nielsen",region:"SJ",level:null,hireDate:"2023-06-04",hours:1000,sickDays:1, breach:false},
        {id:5,name:"Camilla Møller",region:"SJ",level:2,hireDate:"2019-07-02",hours:1000,sickDays:4, breach:false},
        {id:6,name:"Thomas Mortensen",region:"SJ",level:1,hireDate:"2023-05-08",hours:1000,sickDays:20, breach:false},
        {id:7,name:"Allan Kristensen",region:"JY",level:2,hireDate:"1999-05-26",hours:1000,sickDays:0, breach:false},
        {id:8,name:"Henrik Poulsen",region:"JY",level:3,hireDate:"2020-02-07",hours:1000,sickDays:1, breach:false},
        {id:9,name:"Jesper Holm",region:"SJ",level:1,hireDate:"2000-06-15",hours:1000,sickDays:3, breach:false},
        {id:10,name:"Michael Sørensen",region:"SJ",level:3,hireDate:"1972-08-13",hours:1000,sickDays:2, breach:false},
      ],
    };

    function useLocalState(key, init){
      const [state, set] = React.useState(()=>{
        try { const raw = localStorage.getItem(key); return raw? JSON.parse(raw): init; }
        catch { return init; }
      });
      React.useEffect(()=>{ try { localStorage.setItem(key, JSON.stringify(state)); } catch{} }, [state]);
      return [state, set];
    }

    const tenureYears = (iso)=>{
      const s = new Date(iso); const n = new Date();
      let a = n.getFullYear()-s.getFullYear();
      const mdn = (n.getMonth()+1)*100+n.getDate();
      const mds = (s.getMonth()+1)*100+s.getDate();
      if (mdn<mds) a-=1;
      return Math.max(0,a);
    };
    const bucket = (yrs)=> yrs>=5 ? "5+" : yrs>=3 ? "3-4" : yrs>=1 ? "1-2" : "<1";

    function App(){
      const [settings, setSettings] = useLocalState("sw_settings_v2", DEFAULT.settings);
      const [employees, setEmployees] = useLocalState("sw_emps_v2", DEFAULT.employees);

      const regionPools = React.useMemo(()=>{
        const half = settings.totalProfit / 2;
        const costHalf = settings.sharedCosts / 2;
        const after = half - costHalf;
        const pool = after * settings.totalProfitShare;
        return {JY: pool, SJ: pool};
      },[settings]);

      const enriched = React.useMemo(()=> employees.map(e=>{
        const yrs = tenureYears(e.hireDate);
        const sickPct = e.sickDays / (e.hours / settings.hoursPerDay);
        const eligible = yrs>=settings.minYears && e.hours>=settings.minHours && !e.breach && (e.level!=null) && (sickPct<=settings.sickLimitPct);
        const lvf = e.level ? settings.levelFactors[e.level] : 0;
        const sb = bucket(yrs);
        const senf = sb==="<1" ? 0 : settings.seniorityFactors[sb];
        return {...e, yrs, sickPct, eligible, lvf, senf, sb};
      }), [employees, settings]);

      const byRegion = React.useMemo(()=> ({
        JY: enriched.filter(e=>e.region==="JY"),
        SJ: enriched.filter(e=>e.region==="SJ"),
      }), [enriched]);

      const payouts = React.useMemo(()=>{
        const result = {JY:[], SJ:[]};
        ["JY","SJ"].forEach(reg=>{
          const pool = regionPools[reg]||0;
          const qual = byRegion[reg].filter(e=>e.eligible);
          const basePool = pool*settings.shares.base;
          const levelPool = pool*settings.shares.level;
          const senPool = pool*settings.shares.seniority;
          const sumLv = qual.reduce((s,e)=>s+(e.lvf||0),0) || 1;
          const sumSn = qual.reduce((s,e)=>s+(e.senf||0),0) || 1;
          const each = qual.map(e=> ({
            ...e,
            base: basePool/(qual.length||1),
            level: levelPool*(e.lvf/sumLv),
            seniority: senPool*(e.senf/sumSn),
          }));
          result[reg] = each.map(e=>({...e, bonus: e.base+e.level+e.seniority}));
        });
        return result;
      }, [regionPools, byRegion, settings]);

      const totals = React.useMemo(()=> ({
        JY: payouts.JY.reduce((s,e)=>s+e.bonus,0),
        SJ: payouts.SJ.reduce((s,e)=>s+e.bonus,0),
      }),[payouts]);

      const exportJSON = ()=>{
        const blob = new Blob([JSON.stringify({settings, employees}, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob); const a = document.createElement("a");
        a.href=url; a.download="skywork-regional.json"; a.click(); URL.revokeObjectURL(url);
      };
      const importJSON = (file)=>{
        const r = new FileReader();
        r.onload=()=>{ try { const d = JSON.parse(r.result); if(d.settings) setSettings(d.settings); if(d.employees) setEmployees(d.employees);} catch(e){alert("Ugyldig JSON");} };
        r.readAsText(file);
      };

      return (
        <div className="grid gap-8">
          <div className="flex items-center justify-between">
            <div></div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={exportJSON}>Exportér</button>
              <label className="btn cursor-pointer">
                Importér <input type="file" className="hidden" accept="application/json" onChange={(e)=> e.target.files && importJSON(e.target.files[0])} />
              </label>
            </div>
          </div>

          <div className="glass p-6 grid gap-2">
            <div className="flex items-center gap-2"><div>ℹ️</div><h2 className="font-semibold">Sådan fungerer overskudsdelingen</h2></div>
            <p>40% af overskud før skat går til pulje. Fællesudgifter deles ligeligt mellem regionerne. Hver region fordeler egen pulje: 30% ligeligt, 50% efter Level (1:1.0, 2:1.5, 3:2.0), 20% efter anciennitet (1–2:1.0, 3–4:1.3, 5+:1.6). Med i ordningen hvis: 1 år ans., 1000 timer, ingen alvorlige sikkerhedsbrud, sygedage ≤ 5% af planlagt tid.</p>
          </div>

          <div className="grid md:grid-cols-3 gap-4">
            <div className="glass p-5"><div className="text-xs opacity-60">Pulje pr. region</div><div className="text-2xl font-semibold">DKK {(regionPools.JY).toLocaleString('da-DK')}</div></div>
            <div className="glass p-5"><div className="text-xs opacity-60">Kvalificerede (JY / SJ)</div><div className="text-2xl font-semibold">{payouts.JY.length} / {payouts.SJ.length}</div></div>
            <div className="glass p-5"><div className="text-xs opacity-60">Udbetalt (JY / SJ)</div><div className="text-2xl font-semibold">DKK {totals.JY.toLocaleString('da-DK')} / {totals.SJ.toLocaleString('da-DK')}</div></div>
          </div>

          <div className="glass p-6 grid gap-3">
            <h2 className="text-lg font-medium">Medarbejdere</h2>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr><th className="p-2 text-left">Navn</th><th className="p-2">Region</th><th className="p-2">Level</th><th className="p-2">Ansat</th><th className="p-2">Timer</th><th className="p-2">Sygedage</th><th className="p-2">Anc.</th><th className="p-2">Syg%</th><th className="p-2">Status</th></tr></thead>
                <tbody>
                  {enriched.map((e,idx)=>(
                    <tr key={e.id} className="border-t">
                      <td className="p-2"><input value={e.name} onChange={ev=>setEmployees(employees.map((x,i)=>i===idx?{...x,name:ev.target.value}:x))}/></td>
                      <td className="p-2"><select value={e.region} onChange={ev=>setEmployees(employees.map((x,i)=>i===idx?{...x,region:ev.target.value}:x))}><option>JY</option><option>SJ</option></select></td>
                      <td className="p-2"><input type="number" min="1" max="3" value={e.level??""} onChange={ev=>setEmployees(employees.map((x,i)=>i===idx?{...x,level:ev.target.value===""?null:Number(ev.target.value)}:x))}/></td>
                      <td className="p-2"><input type="date" value={e.hireDate} onChange={ev=>setEmployees(employees.map((x,i)=>i===idx?{...x,hireDate:ev.target.value}:x))}/></td>
                      <td className="p-2"><input type="number" value={e.hours} onChange={ev=>setEmployees(employees.map((x,i)=>i===idx?{...x,hours:Number(ev.target.value)}:x))}/></td>
                      <td className="p-2"><input type="number" value={e.sickDays} onChange={ev=>setEmployees(employees.map((x,i)=>i===idx?{...x,sickDays:Number(ev.target.value)}:x))}/></td>
                      <td className="p-2">{e.yrs} år</td>
                      <td className="p-2">{(e.sickPct*100).toFixed(1)}%</td>
                      <td className="p-2">{e.eligible? "Godkendt":"Ikke med"}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          <div className="grid lg:grid-cols-2 gap-4">
            {["JY","SJ"].map(reg=>{
              const data = payouts[reg].map(x=>({name:x.name, bonus: Math.round(x.bonus)}));
              return (
                <div key={reg} className="glass p-6">
                  <h2 className="text-lg font-medium mb-2">Bonus pr. medarbejder — {reg}</h2>
                  <div style={{width:'100%',height:300}}>
                    <ResponsiveContainer width="100%" height={300}>
                      <BarChart data={data}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name"/><YAxis/><Tooltip/><Legend/><Bar dataKey="bonus" name="Bonus"/></BarChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              );
            })}
          </div>

          <div className="text-center text-xs opacity-60 py-6">Tip: Del linket direkte (GitHub Pages). Export/Import af JSON understøttes.</div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
