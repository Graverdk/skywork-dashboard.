<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sky-Work Bonus — (Recharts + Fallback)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Primary Recharts CDN -->
  <script id="recharts-cdn" src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
  <script>
    // If Recharts didn't load in 2000ms, try unpkg fallback
    setTimeout(function(){
      if (!window.Recharts) {
        var s = document.createElement('script');
        s.src = 'https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js';
        s.onload = function(){ console.log('Loaded Recharts from unpkg fallback'); };
        s.onerror = function(){
          var box = document.getElementById('errors');
          if (box) { box.style.display='block'; box.textContent += 'Kunne ikke loade Recharts fra nogen CDN. Viser i stedet tal uden graf.\n'; }
        };
        document.head.appendChild(s);
      }
    }, 2000);
  </script>

  <style>
    body { background: radial-gradient(1200px 600px at 10% -10%, rgba(99,102,241,.10), transparent),
                       radial-gradient(1200px 600px at 90% -10%, rgba(16,185,129,.10), transparent); }
    .glass { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); background: rgba(255,255,255,.60);
      border:1px solid rgba(255,255,255,.40); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06) }
    input, select { border:1px solid rgba(0,0,0,.15); border-radius:10px; padding:8px 10px; }
    button.btn { border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:8px 12px; }
    #errors { white-space: pre-wrap; color:#991b1b; background:#fff1f2; padding:12px; border-radius:12px; margin-top:12px; display:none }
  </style>
  <script>
    window.addEventListener('error', function(e){
      var box = document.getElementById('errors'); if(!box) return;
      box.style.display='block'; box.textContent += (e.message || (e.error && e.error.message) || e.toString()) + "\n";
    });
  </script>
</head>
<body class="min-h-screen">
  <div class="p-6 md:p-10 max-w-7xl mx-auto">
    <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">Sky-Work Bonus — Regioner</h1>
    <p class="opacity-70">Hvis graf-bibliotek blokeres på netværket, ser du stadig tallene nedenfor.</p>
    <div id="errors"></div>
    <div id="root" class="mt-6"></div>
  </div>

  <script type="text/babel">
    const {useState, useMemo} = React;

    const DEFAULT = {
      settings: {
        totalProfit: 1000000,
        sharedCosts: 200000,
        totalProfitShare: 0.40,
        shares: { base: 0.30, level: 0.50, seniority: 0.20 },
        sickLimitPct: 0.05,
        hoursPerDay: 7.4,
        minYears: 1,
        minHours: 1000,
        levelFactors: {1:1.0,2:1.5,3:2.0},
        seniorityFactors: {"1-2":1.0,"3-4":1.3,"5+":1.6},
      },
      employees: [
        {id:1,name:"Mads Jensen",region:"JY",level:1,hireDate:"2022-05-23",hours:1000,sickDays:2, breach:false},
        {id:2,name:"Jonas Larsen",region:"SJ",level:2,hireDate:"2022-08-17",hours:1000,sickDays:3, breach:false},
        {id:3,name:"Peter Hansen",region:"JY",level:3,hireDate:"2019-01-02",hours:1000,sickDays:0, breach:false},
        {id:4,name:"Sofie Nielsen",region:"SJ",level:null,hireDate:"2023-06-04",hours:1000,sickDays:1, breach:false},
        {id:5,name:"Camilla Møller",region:"SJ",level:2,hireDate:"2019-07-02",hours:1000,sickDays:4, breach:false},
        {id:6,name:"Thomas Mortensen",region:"SJ",level:1,hireDate:"2023-05-08",hours:1000,sickDays:20, breach:false},
        {id:7,name:"Allan Kristensen",region:"JY",level:2,hireDate:"1999-05-26",hours:1000,sickDays:0, breach:false},
        {id:8,name:"Henrik Poulsen",region:"JY",level:3,hireDate:"2020-02-07",hours:1000,sickDays:1, breach:false},
        {id:9,name:"Jesper Holm",region:"SJ",level:1,hireDate:"2000-06-15",hours:1000,sickDays:3, breach:false},
        {id:10,name:"Michael Sørensen",region:"SJ",level:3,hireDate:"1972-08-13",hours:1000,sickDays:2, breach:false},
      ],
    };

    const tenureYears = (iso)=>{
      const s = new Date(iso); const n = new Date();
      let a = n.getFullYear()-s.getFullYear();
      const mdn = (n.getMonth()+1)*100+n.getDate();
      const mds = (s.getMonth()+1)*100+s.getDate();
      if (mdn<mds) a-=1;
      return Math.max(0,a);
    };
    const bucket = (yrs)=> yrs>=5 ? "5+" : yrs>=3 ? "3-4" : yrs>=1 ? "1-2" : "<1";

    function App(){
      const [settings, setSettings] = useState(DEFAULT.settings);
      const [employees, setEmployees] = useState(DEFAULT.employees);

      const regionPools = useMemo(()=>{
        const half = settings.totalProfit / 2;
        const costHalf = settings.sharedCosts / 2;
        const after = half - costHalf;
        const pool = after * settings.totalProfitShare;
        return {JY: pool, SJ: pool};
      },[settings]);

      const enriched = useMemo(()=> employees.map(e=>{
        const yrs = tenureYears(e.hireDate);
        const sickPct = e.sickDays / (e.hours / settings.hoursPerDay);
        const eligible = yrs>=settings.minYears && e.hours>=settings.minHours && !e.breach && (e.level!=null) && (sickPct<=settings.sickLimitPct);
        const lvf = e.level ? settings.levelFactors[e.level] : 0;
        const sb = bucket(yrs);
        const senf = sb==="<1" ? 0 : settings.seniorityFactors[sb];
        return {...e, yrs, sickPct, eligible, lvf, senf, sb};
      }), [employees, settings]);

      const byRegion = useMemo(()=> ({
        JY: enriched.filter(e=>e.region==="JY"),
        SJ: enriched.filter(e=>e.region==="SJ"),
      }), [enriched]);

      const payouts = useMemo(()=>{
        const result = {JY:[], SJ:[]};
        ["JY","SJ"].forEach(reg=>{
          const pool = regionPools[reg]||0;
          const qual = byRegion[reg].filter(e=>e.eligible);
          const basePool = pool*settings.shares.base;
          const levelPool = pool*settings.shares.level;
          const senPool = pool*settings.shares.seniority;
          const sumLv = qual.reduce((s,e)=>s+(e.lvf||0),0) || 1;
          const sumSn = qual.reduce((s,e)=>s+(e.senf||0),0) || 1;
          const each = qual.map(e=> ({
            ...e,
            base: basePool/(qual.length||1),
            level: levelPool*(e.lvf/sumLv),
            seniority: senPool*(e.senf/sumSn),
          }));
          result[reg] = each.map(e=>({...e, bonus: e.base+e.level+e.seniority}));
        });
        return result;
      }, [regionPools, byRegion, settings]);

      const canChart = !!window.Recharts;

      return (
        <div className="grid gap-8">
          <div className="grid lg:grid-cols-2 gap-4">
            {["JY","SJ"].map(reg=>{
              const data = payouts[reg].map(x=>({name:x.name, bonus: Math.round(x.bonus)}));
              return (
                <div key={reg} className="glass p-6">
                  <h2 className="text-lg font-medium mb-2">Bonus pr. medarbejder — {reg}</h2>
                  {canChart ? (
                    <div style={{width:'100%',height:300}}>
                      <window.Recharts.ResponsiveContainer width="100%" height={300}>
                        <window.Recharts.BarChart data={data}>
                          <window.Recharts.CartesianGrid strokeDasharray="3 3"/>
                          <window.Recharts.XAxis dataKey="name"/>
                          <window.Recharts.YAxis/>
                          <window.Recharts.Tooltip/>
                          <window.Recharts.Legend/>
                          <window.Recharts.Bar dataKey="bonus" name="Bonus"/>
                        </window.Recharts.BarChart>
                      </window.Recharts.ResponsiveContainer>
                    </div>
                  ) : (
                    <div className="text-sm opacity-70">Grafbibliotek kunne ikke hentes — viser tabel:</div>
                  )}
                  {!canChart && (
                    <table className="mt-3 text-sm w-full">
                      <thead><tr><th className="text-left">Navn</th><th className="text-right">Bonus</th></tr></thead>
                      <tbody>
                        {data.map((d,i)=>(<tr key={i}><td>{d.name}</td><td className="text-right">DKK {d.bonus.toLocaleString('da-DK')}</td></tr>))}
                      </tbody>
                    </table>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
